{% extends 'puzzles/base.html' %}
{% load jalali_tags %}

{% block content %}
<style>
    /* ... (Ù‡Ù…ÙˆÙ† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒØª Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±) ... */
    .admin-table { width: 100%; text-align: right; border-collapse: collapse; color: white; background: #16213e; border-radius: 12px; overflow: hidden; }
    .admin-table th { background: rgba(0,0,0,0.3); padding: 15px 10px; border-bottom: 2px solid #555; }
    .admin-table td { padding: 15px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
    .sort-link { color: #e0b0ff; text-decoration: none; display: flex; align-items: center; gap: 5px; }
    .sort-link:hover { color: #fff; }

    .verify-box { display: none; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #4fc3f7; }
    .date-input { background: #0f3460; border: 1px solid #fff; color: #fff; padding: 5px; border-radius: 5px; font-family: inherit; }
    .verify-btn { background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: bold; }
    .unverify-btn { background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 0.8rem; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <a href="{% url 'home' %}" style="font-size: 1.5rem; color: white; text-decoration: none;">&#8594;</a>
    <h2 style="margin: 0; color: #ffca28;">ğŸ›¡ï¸ Ù¾Ù†Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹Ù…Ø§Ù‡Ø§</h2>
    <div></div>
</div>

{% if messages %}
    {% for message in messages %}
        <div style="padding: 15px; border-radius: 10px; margin-bottom: 20px;
            background: {% if message.tags == 'success' %}#4caf50{% elif message.tags == 'warning' %}#ff9800{% else %}#f44336{% endif %}; color: white;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
    <div style="font-size: 0.9rem; color: #a0a0a0;">
        ğŸ“… Ø§ÙˆÙ„ÛŒÙ† ØªØ§Ø±ÛŒØ® Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ´Ø§Ø±: <strong>{{ next_available_date }}</strong>
    </div>

    <div>
        {% if show_all %}
            <a href="?show_all=false&sort={{ current_sort }}" class="btn" style="background: #e94560; margin: 0; height: auto; padding: 8px 15px; font-size: 0.9rem;">Ù†Ù…Ø§ÛŒØ´ ÙÙ‚Ø· Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±/Ø¢ÛŒÙ†Ø¯Ù‡</a>
        {% else %}
            <a href="?show_all=true&sort={{ current_sort }}" class="btn" style="background: #4fc3f7; color: #000; margin: 0; height: auto; padding: 8px 15px; font-size: 0.9rem;">Ù†Ù…Ø§ÛŒØ´ Ú©Ù„ Ù…Ø¹Ù…Ø§Ù‡Ø§ÛŒ Ø³Ø§ÛŒØª</a>
        {% endif %}
    </div>
</div>

<div style="border: 2px solid #fff; border-radius: 12px; overflow-x: auto;">
    <table class="admin-table">
        <thead>
            <tr>
                <th>
                    <a href="?show_all={{ show_all|lower }}&sort={% if current_sort == 'date' %}-date{% else %}date{% endif %}" class="sort-link">
                        ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª {% if current_sort == 'date' %}â†‘{% elif current_sort == '-date' %}â†“{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?show_all={{ show_all|lower }}&sort={% if current_sort == 'author__username' %}-author__username{% else %}author__username{% endif %}" class="sort-link">
                        Ø·Ø±Ø§Ø­ {% if current_sort == 'author__username' %}â†‘{% elif current_sort == '-author__username' %}â†“{% endif %}
                    </a>
                </th>
                <th>Ù¾Ø§Ø³Ø® (ØªØ³Øª)</th>
                <th>
                    <a href="?show_all={{ show_all|lower }}&sort={% if current_sort == 'publish_date' %}-publish_date{% else %}publish_date{% endif %}" class="sort-link">
                        ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø± {% if current_sort == 'publish_date' %}â†‘{% elif current_sort == '-publish_date' %}â†“{% endif %}
                    </a>
                </th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø¯Ù…ÛŒÙ†</th>
            </tr>
        </thead>
        <tbody>
            {% for p in puzzles %}
            <tr>
                <td style="font-size: 0.85rem; color: #aaa;">{{ p.date|to_jalali }}</td>
                <td style="font-weight: bold;">{{ p.author.username }}</td>
                <td>
                    <a href="{% url 'play_private' p.id %}" style="color: #4fc3f7; text-decoration: none;">
                        {{ p.answer }}
                    </a>
                </td>
                <td>
                    {% if p.is_verified %}
                        <span style="color: #4caf50;">{{ p.publish_date|to_jalali }}</span>
                    {% else %}
                        <span style="color: #ff9800;">ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡</span>
                    {% endif %}
                </td>
                <td>
                    {% if p.is_verified %}
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="cursor: pointer; color: #4fc3f7; font-size: 0.9rem;">
                                <input type="checkbox" onchange="toggleVerifyBox(this, 'box_{{ p.id }}')"> ØªØºÛŒÛŒØ± ØªØ§Ø±ÛŒØ®
                            </label>

                            <form method="POST" style="margin: 0;">
                                {% csrf_token %}
                                <input type="hidden" name="puzzle_id" value="{{ p.id }}">
                                <input type="hidden" name="action" value="unverify">
                                <button type="submit" class="unverify-btn">Ù„ØºÙˆ ØªØ§ÛŒÛŒØ¯ âœ–</button>
                            </form>
                        </div>
                    {% else %}
                        <label style="cursor: pointer; color: #ffca28;">
                            <input type="checkbox" onchange="toggleVerifyBox(this, 'box_{{ p.id }}')"> ØªØ§ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ
                        </label>
                    {% endif %}

                    <div id="box_{{ p.id }}" class="verify-box">
                        <form method="POST" style="display: flex; gap: 5px; align-items: center;">
                            {% csrf_token %}
                            <input type="hidden" name="puzzle_id" value="{{ p.id }}">
                            <input type="hidden" name="action" value="verify">
                            <input type="date" name="publish_date" class="date-input" required
                                   value="{% if p.is_verified %}{{ p.publish_date|date:'Y-m-d' }}{% else %}{{ next_available_date }}{% endif %}">
                            <button type="submit" class="verify-btn">Ø«Ø¨Øª</button>
                        </form>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <a href="{% url 'edit_puzzle' p.id %}" style="color: #4fc3f7; text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <span>ğŸ“</span> ÙˆÛŒØ±Ø§ÛŒØ´
                        </a>

                        <a href="{% url 'delete_puzzle' p.id %}"
                           style="color: #f44336; text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;"
                           onclick="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§ÛŒÙ† Ù…Ø¹Ù…Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')">
                            <span>ğŸ—‘ï¸</span> Ø­Ø°Ù
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px;">Ù‡ÛŒÚ† Ù…Ø¹Ù…Ø§ÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function toggleVerifyBox(checkbox, boxId) {
        const box = document.getElementById(boxId);
        if (checkbox.checked) {
            box.style.display = 'block';
            box.style.animation = 'fadeIn 0.3s';
        } else {
            box.style.display = 'none';
        }
    }
</script>
{% endblock %}