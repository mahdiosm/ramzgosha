{% extends 'puzzles/base.html' %}

{% block content %}
<style>
    .stats-box {
        background-color: #cde2fe; /* Ù‡Ù…ÙˆÙ† Ø±Ù†Ú¯ Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù†Ù Ø¹Ú©Ø³ */
        color: #000;
        border-radius: 12px;
        padding: 20px;
        margin: 20px auto 40px auto;
        max-width: 400px;
        text-align: right;
        font-family: 'Vazirmatn', sans-serif;
    }
    .stats-title {
        font-size: 1.2rem;
        font-weight: 900;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 1.05rem;
    }
    .stat-row:last-child {
        margin-bottom: 0;
    }
    .stat-label {
        color: #333; /* Ú©Ù…ÛŒ Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ */
    }
    .stat-value {
        font-weight: 900;
        font-size: 1.1rem;
    }

    .puzzle-container {
        direction: rtl; /* Ú†ÛŒØ¯Ù…Ø§Ù† Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾ */
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
        margin: 30px 0;
    }

    @media (max-width: 400px) {
        .char-input {
            width: 32px;
            height: 42px;
            font-size: 1.2rem;
            border-width: 2px;
        }
    }

    .char-input {
        width: 40px;
        height: 50px;
        font-size: 1.4rem;
        text-align: center;
        background-color: transparent;
        border: 3px solid #fff;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        font-family: 'Vazirmatn', sans-serif;
        outline: none;
        transition: all 0.2s;
        caret-color: transparent; /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù†Ø´Ø§Ù†Ú¯Ø± ØªØ§ÛŒÙ¾ */
    }

    .char-input:focus {
        border-color: #e0b0ff;
        background-color: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ ÙˆÙ‚ØªÛŒ Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ */
    .char-input:disabled {
        border-color: #4caf50;
        color: #4caf50;
        opacity: 1;
        -webkit-text-fill-color: #4caf50;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø­Ø±Ù Ù„Ùˆ Ø±ÙØªÙ‡ (Reveal) - ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± */
    .char-input.revealed {
        background-color: #e94560 !important;
        color: #fff !important;
        border-color: #e94560 !important;
        pointer-events: none; /* ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© */
    }

    /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ --- */
    .hint-span {
        border-radius: 4px;
        padding: 2px 0px;
        transition: all 0.3s;
        cursor: default;
        border-bottom: 2px solid transparent; /* Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø´ Ù…ÙˆÙ‚Ø¹ Ø§Ú©ØªÛŒÙˆ Ø´Ø¯Ù† */
    }

    /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ */
    /* Definition: Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† */
    .hint-def.active {
        background-color: rgba(79, 195, 247, 0.25);
        color: #4fc3f7;
        border-bottom-color: #4fc3f7;
    }

    /* Fodder: Ø²Ø±Ø¯ Ú©Ù‡Ø±Ø¨Ø§ÛŒÛŒ/Ù†Ø§Ø±Ù†Ø¬ÛŒ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯ Ø¨Ù‡ØªØ±) */
    .hint-fod.active {
        background-color: rgba(255, 179, 0, 0.25); /* Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ø²Ø±Ø¯ ØªÛŒØ±Ù‡â€ŒØªØ± */
        color: #ffb300; /* Ù…ØªÙ† Ø²Ø±Ø¯ Ù¾Ø±Ø±Ù†Ú¯ */
        border-bottom-color: #ffb300;
    }

    /* Indicator: ØµÙˆØ±ØªÛŒ */
    .hint-ind.active {
        background-color: rgba(240, 98, 146, 0.25);
        color: #f06292;
        border-bottom-color: #f06292;
    }

    /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ø² Ø¨ÙˆØ¯Ù† */
    .buttons-container {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        align-items: center; /* ØªØ±Ø§Ø² Ø¹Ù…ÙˆØ¯ÛŒ Ø¯Ù‚ÛŒÙ‚ */
        gap: 15px; /* ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
    }

    /* Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ */
    .btn-hint {
        background-color: #ffca28;
        color: #000;
        border: 2px solid #000;
        box-shadow: 3px 3px 0px #000;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-family: inherit;
        font-size: 1rem;
        height: 46px; /* Ø§Ø±ØªÙØ§Ø¹ ÙÛŒÚ©Ø³ Ø¨Ø±Ø§ÛŒ Ù‡Ù…â€ŒØ§Ù†Ø¯Ø§Ø²Ù‡ Ø¨ÙˆØ¯Ù† Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø±Ø³ÛŒ */
        display: flex;
        align-items: center;
    }
    .btn-hint:active { transform: translate(3px, 3px); box-shadow: none; }

    /* Ø§ØµÙ„Ø§Ø­ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ */
    .btn {
        margin-top: 0; /* Ø­Ø°Ù Ù…Ø§Ø±Ø¬ÛŒÙ† Ø§Ø¶Ø§ÙÛŒ */
        height: 46px;
        display: flex;
        align-items: center;
    }

    /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù…ÙˆØ¯Ø§Ù„ --- */
    .modal-overlay {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    .modal-box {
        background: #1a1a2e;
        border: 2px solid #fff;
        border-radius: 15px;
        padding: 20px;
        width: 90%; max-width: 400px;
        text-align: right;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .hint-option {
        padding: 15px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }
    .hint-option:hover { background: #232342; border-radius: 5px; }
    .hint-option:last-child { border-bottom: none; }

    /* Ø¨Ø§Ú©Ø³ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø²ÛŒØ± Ù…Ø¹Ù…Ø§ */
    #hint-description-box {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255,255,255,0.05);
        border-right: 4px solid;
        border-radius: 5px;
        font-size: 0.95rem;
        line-height: 1.6;
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <a href="{% url 'home' %}" style="font-size: 1.5rem; color: white;">&#8594;</a>
    <div style="text-align: center;">
        {{ puzzle.publish_date|date:"j F Y" }} <br>
        <small style="color: #a0a0a0;">Ø·Ø±Ø§Ø­: {{ puzzle.author.username }}</small>
    </div>
    <div style="cursor: pointer;">â„¹ï¸</div>
</div>

<div style="background: #fff; color: #000; padding: 25px; border-radius: 12px; margin-bottom: 10px; font-size: 1.3rem; line-height: 2; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
    {{ puzzle.html_render }}
    <span style="font-size: 0.9rem; color: #666; vertical-align: middle; margin-right: 5px;">({{ puzzle.answer_length }})</span>
</div>

<div id="hint-description-box"></div>

<form method="POST" id="puzzleForm" autocomplete="off">
    {% csrf_token %}
    <input type="hidden" name="guess" id="full-guess">

    <input type="hidden" name="hint_def_used" id="hint_def_used" value="{{ hint_def_used }}">
    <input type="hidden" name="hint_fod_used" id="hint_fod_used" value="{{ hint_fod_used }}">
    <input type="hidden" name="hint_ind_used" id="hint_ind_used" value="{{ hint_ind_used }}">
    <input type="hidden" name="letters_revealed" id="letters_revealed" value="{{ letters_revealed }}">

    <div class="puzzle-container">
        {% for i in "x"|rjust:puzzle.answer_length %}
            <input type="text"
                   class="char-input"
                   maxlength="1"
                   inputmode="text"
                   {% if is_correct %}disabled{% endif %}
                   data-index="{{ forloop.counter0 }}">
        {% endfor %}
    </div>

    <div class="buttons-container">
        {% if not is_correct %}
            <button type="submit" class="btn" onclick="prepareSubmission()">Ø¨Ø±Ø±Ø³ÛŒ</button>
            <button type="button" class="btn-hint" onclick="openHintModal()">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ ğŸ’¡</button>
        {% endif %}
    </div>
</form>

<div style="margin-top: 20px;">
    {% if messages %}
        {% for message in messages %}
            {% if not is_correct or message.tags != 'success' %}
            <div style="padding: 15px; border-radius: 10px; margin-bottom: 20px; animation: fadeIn 0.5s;
                background: {% if message.tags == 'success' %}#4caf50{% else %}#f44336{% endif %}; color: white;">
                {{ message }}
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if is_correct %}
        <div class="stats-box" style="animation: fadeIn 1s ease-out;">
            <div class="stats-title">ğŸ† Ø¢ÙØ±ÛŒÙ†! Ù¾Ø§Ø³Ø®Øª Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯</div>

            <div class="stat-row">
                <span class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø­Ù„ ØªØ§ Ø§Ù„Ø§Ù†</span>
                <span class="stat-value">{{ puzzle.solve_count }} Ù†ÙØ±</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ (Ø¬Ø§Ù…Ø¹Ù‡)</span>
                <span class="stat-value">{{ puzzle.average_hints }} Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</span>
            </div>
            <div class="stat-row" style="margin-top: 25px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1);">
                <span class="stat-label" style="color: #000; font-weight: bold;">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</span>
                <span class="stat-value">{{ user_hints_used }} Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</span>
            </div>
        </div>
    {% endif %}

    {% if not is_private %}
        {% if is_correct %}
            <div style="animation: fadeIn 1s ease-out; margin-top: 30px;">
                {% include 'puzzles/archive_list.html' %}
            </div>
        {% endif %}
    {% endif %}
</div>

<div class="modal-overlay" id="hintModal">
    <div class="modal-box">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">
            <h3 style="margin:0;">Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</h3>
            <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeHintModal()">&times;</span>
        </div>

        <div class="hint-option" onclick="toggleHint('ind', '{{ puzzle.desc_indicators|escapejs }}', '#f06292')">
            <span style="border-bottom: 3px solid #f06292; color: #f06292; font-weight: bold;">Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§ (Indicators)</span>
            <span>ğŸ‘ï¸</span>
        </div>
        <div class="hint-option" onclick="toggleHint('fod', '{{ puzzle.desc_fodder|escapejs }}', '#ffb300')">
            <span style="border-bottom: 3px solid #ffb300; color: #ffb300; font-weight: bold;">Ù…ØµØ§Ù„Ø­ (Fodder)</span>
            <span>ğŸ§±</span>
        </div>
        <div class="hint-option" onclick="toggleHint('def', '{{ puzzle.desc_definition|escapejs }}', '#4fc3f7')">
            <span style="border-bottom: 3px solid #4fc3f7; color: #4fc3f7; font-weight: bold;">ØªØ¹Ø±ÛŒÙ (Definition)</span>
            <span>ğŸ“–</span>
        </div>
        <div class="hint-option" onclick="revealOneLetter()">
            <span style="border-bottom: 3px solid #e94560; color: #e94560; font-weight: bold;">Ù†Ù…Ø§ÛŒØ´ ÛŒÚ© Ø­Ø±Ù</span>
            <span>ğŸ…°ï¸</span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.char-input');
        const hiddenInput = document.getElementById('full-guess');

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø®Ø§Ù†Ù‡ Ø®Ø§Ù„ÛŒ Ùˆ ØºÛŒØ± Ù‚ÙÙ„ Ø¨Ø±Ø§ÛŒ ÙÙˆÚ©ÙˆØ³
        function focusFirstAvailable() {
            for(let i=0; i<inputs.length; i++) {
                if(!inputs[i].disabled && !inputs[i].classList.contains('revealed')) {
                    inputs[i].focus();
                    break;
                }
            }
        }

        // Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡ØŒ ÙÙˆÚ©ÙˆØ³ Ú©Ù†
        if(inputs.length > 0 && !inputs[0].disabled) {
            focusFirstAvailable();
        }

        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    // Ø§Ú¯Ø± Ø§ÛŒÙ† Ø®Ø§Ù†Ù‡ Ø®Ø§Ù„ÛŒÙ‡ØŒ Ø¨Ø±Ùˆ Ù‚Ø¨Ù„ÛŒ (Ú©Ù‡ revealed Ù†ÛŒØ³Øª) Ùˆ Ù¾Ø§Ú©Ø´ Ú©Ù†
                    if (input.value === '') {
                        let prevIndex = index - 1;
                        while(prevIndex >= 0) {
                            if (!inputs[prevIndex].classList.contains('revealed')) {
                                inputs[prevIndex].focus();
                                inputs[prevIndex].value = '';
                                e.preventDefault();
                                break;
                            }
                            prevIndex--;
                        }
                    } else {
                        // Ø§Ú¯Ø± Ù¾Ø± Ø¨ÙˆØ¯ ÙÙ‚Ø· Ù¾Ø§Ú©Ø´ Ú©Ù†
                        input.value = '';
                    }
                }
                else if (e.key === 'ArrowLeft') {
                    let nextIndex = index + 1;
                    while (nextIndex < inputs.length) {
                         if (!inputs[nextIndex].classList.contains('revealed')) {
                             inputs[nextIndex].focus();
                             break;
                         }
                         nextIndex++;
                    }
                }
                else if (e.key === 'ArrowRight') {
                    let prevIndex = index - 1;
                    while (prevIndex >= 0) {
                        if (!inputs[prevIndex].classList.contains('revealed')) {
                            inputs[prevIndex].focus();
                            break;
                        }
                        prevIndex--;
                    }
                }
            });

            input.addEventListener('input', (e) => {
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯
                if (input.value.length === 1) {
                    // Ø¨Ø±Ùˆ Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø¨Ø¹Ø¯ÛŒ Ú©Ù‡ revealed Ù†ÛŒØ³Øª
                    let nextIndex = index + 1;
                    while(nextIndex < inputs.length) {
                        if(!inputs[nextIndex].classList.contains('revealed')) {
                            inputs[nextIndex].focus();
                            break;
                        }
                        nextIndex++;
                    }
                }
                updateHiddenInput();
            });

            input.addEventListener('focus', function() {
                this.select();
            });
        });

        function updateHiddenInput() {
            let fullWord = '';
            inputs.forEach(inp => {
                fullWord += inp.value;
            });
            hiddenInput.value = fullWord;
        }

        window.prepareSubmission = function() {
            updateHiddenInput();
        }

        window.openHintModal = function() {
            document.getElementById('hintModal').style.display = 'flex';
        }

        window.closeHintModal = function() {
            document.getElementById('hintModal').style.display = 'none';
        }

        document.getElementById('hintModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHintModal();
            }
        });

        // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ØªØ§Ú¯Ù„ Ú©Ø±Ø¯Ù† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ø¯ÙˆÙ† Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¨Ù‚ÛŒÙ‡
        window.toggleHint = function(type, desc, color) {
            closeHintModal();

            document.getElementById('hint_' + type + '_used').value = 'true';
            const targets = document.querySelectorAll('.hint-' + type);
            // Ú†Ú© Ù…ÛŒÚ©Ù†ÛŒÙ… Ø§Ú¯Ø± Ø§Ù„Ø§Ù† ÙØ¹Ø§Ù„Ù‡ØŒ ØºÛŒØ±ÙØ¹Ø§Ù„Ø´ Ú©Ù†ÛŒÙ… ÛŒØ§ Ù†Ù‡ØŸ
            // Ù…Ø¹Ù…ÙˆÙ„Ø§ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒØ®ÙˆØ§Ø¯ Ø±ÙˆØ´Ù†Ø´ Ú©Ù†Ù‡. Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø±ÙˆØ´Ù†Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø²Ø¯ Ø´Ø§ÛŒØ¯ Ø¨Ø®ÙˆØ§Ø¯ Ø®Ø§Ù…ÙˆØ´ Ú©Ù†Ù‡
            // ÙØ¹Ù„Ø§ ÙØ±Ø¶ Ù…ÛŒÚ©Ù†ÛŒÙ… ÙÙ‚Ø· Ø±ÙˆØ´Ù† Ù…ÛŒÚ©Ù†Ù‡ (Ú†ÙˆÙ† Ú¯ÙØªÛŒ Ù†Ù…ÛŒØ®ÙˆØ§ÛŒ Ø¨Ù‚ÛŒÙ‡ Ø¨Ù¾Ø±Ù†)

            let isAnyActive = false;
            targets.forEach(el => {
                if(el.classList.contains('active')) isAnyActive = true;
                el.classList.toggle('active');
            });

            // Ø¨Ø§Ú©Ø³ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù† Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡
            const box = document.getElementById('hint-description-box');

            // Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù„ÛŒÚ© Ú©Ù„Ø§Ø³ active Ú¯Ø±ÙØª Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
            // Ø§Ú¯Ø± Ù…ÛŒØ®ÙˆØ§ÛŒ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø§Ú© Ù†Ø´Ù‡ØŒ Ø³Ø§Ø¯Ù‡â€ŒØªØ±ÛŒÙ† Ø±Ø§Ù‡ Ø§ÛŒÙ†Ù‡ Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯ÛŒ
            box.style.display = 'block';
            box.style.borderColor = color;
            box.style.color = '#fff';
            box.innerText = desc || "ØªÙˆØ¶ÛŒØ­ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
        }

        window.revealOneLetter = function() {
            closeHintModal();

            const currentInputs = document.querySelectorAll('.char-input');
            const revealedIndices = [];
            currentInputs.forEach((inp, idx) => {
                if (inp.classList.contains('revealed') || inp.value !== '') {
                    revealedIndices.push(idx);
                }
            });

            fetch("{% url 'reveal_letter' puzzle.publish_date|date:'Y-m-d' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ exclude: revealedIndices })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const targetInput = document.querySelector(`.char-input[data-index="${data.index}"]`);
                    if (targetInput) {
                        targetInput.value = data.char;
                        targetInput.classList.add('revealed');
                        updateHiddenInput();
                        let lrInput = document.getElementById('letters_revealed');
                        lrInput.value = parseInt(lrInput.value || 0) + 1;
                        // Ø¨Ø¹Ø¯ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ØŒ ÙÙˆÚ©ÙˆØ³ Ø±Ùˆ Ø¨Ø¨Ø± Ø¬Ø§ÛŒ Ø¯Ø±Ø³Øª
                        focusFirstAvailable();
                    }
                } else if (data.status === 'full') {
                    alert('Ù‡Ù…Ù‡ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ù¾Ø± Ù‡Ø³ØªÙ†Ø¯ ÛŒØ§ Ø¨Ø§Ø² Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯!');
                }
            })
            .catch(err => console.error('Error revealing letter:', err));
        }
    });
</script>

{% if is_correct %}
    <script>
        // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ø´Ø¯ Ùˆ Ø¨Ø±Ù†Ø¯Ù‡ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø¬ÙˆØ§Ø¨ Ø±Ùˆ ØªÙˆÛŒ Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ°Ø§Ø±ÛŒÙ…
        document.addEventListener('DOMContentLoaded', function() {
            const correctAnswer = "{{ puzzle.answer }}".replace(/\s+/g, '');
            const inputs = document.querySelectorAll('.char-input');

            inputs.forEach((input, index) => {
                if (correctAnswer[index]) {
                    input.value = correctAnswer[index];
                }
            });
        });
    </script>
    {% endif %}
{% endblock %}